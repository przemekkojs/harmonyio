@page
@model Main.Pages.CreatedModel
@using Main.Enumerations;
@{
    var sketches = Model.UsersQuizes.Where(q => !q.IsCreated).ToList();
    var allPublished = Model.UsersQuizes.Where(q => q.IsCreated).ToList();

    var readyToGrade = allPublished.Where(q => Model.IsReadyToGrade(q)).ToList();
    var closed = allPublished.Except(readyToGrade).Where(q => q.QuizResults.Count > 0).ToList();
    var published = allPublished.Except(readyToGrade).Except(closed).ToList();
}

<head>
    <link rel="stylesheet" href="~/css/quiz-lists-style.css" />
</head>

<div class="h-100 w-100 d-flex flex-column flex-md-row mb-3">
    <div class="w-100 w-md-50 flex-grow-1 overflow-md-auto d-flex flex-column bg-white rounded shadow px-3 pt-3 me-3 mb-3">
        @if (allPublished.Count > 0)
        {
            @if (readyToGrade.Count > 0)
            {
                <div class="fw-bold fs-4 mb-3">Do Oceny</div>
            }
            @foreach (var quiz in readyToGrade)
            {
                <div class="border rounded shadow-sm mb-3 p-0 flex-shrink-0 d-flex flex-row p-3">
                    <div class="flex-grow-1 d-flex flex-column flex-basis-0 overflow-hidden">
                        <div class="fw-bold fs-5 mb-3 text-truncate">@quiz.Name</div>

                        <div class="d-flex flex-row align-items-center mb-2">
                            <i class="far fa-clock icon-sm me-2"></i>
                            <span class="text-truncate">
                                <span class="fw-bold">Otwarcie:</span> 
                                @quiz.OpenDate
                            </span>
                        </div>
                        <div class="d-flex flex-row align-items-center mb-2">
                            <i class="far fa-clock icon-sm me-2"></i>
                            <span class="text-truncate">
                                <span class="fw-bold">Zamknięcie:</span> 
                                @quiz.CloseDate
                            </span>
                        </div>
                        <div class="d-flex flex-row align-items-center">
                            <i class="fas fa-user-group icon-sm me-2"></i>
                            <span class="text-truncate">
                                <span class="fw-bold">Wypełniono:</span> 
                                @Model.QuizesToUsersCompleted[quiz].Item1 / @Model.QuizesToUsersCompleted[quiz].Item2
                            </span>
                        </div>
                    </div>

                    <div class="d-flex flex-column h-100 ms-2">
                        <a asp-page="Grade" asp-route-id="@quiz.Id" class="btn btn-primary ms-auto mt-auto">Oceń</a>
                    </div>
                </div>
            }

            @if (published.Count > 0)
            {
                <div class="fw-bold fs-4 mb-3">Opublikowane</div>
            }
            @foreach (var quiz in published)
            {
                <div class="border rounded shadow-sm mb-3 p-0 d-flex flex-row flex-shrink-0 p-3">
                    <div class="flex-grow-1 d-flex flex-column flex-column flex-basis-0 overflow-hidden">
                        <div class="fw-bold fs-5 mb-3 text-truncate" style="max-width: 100%;">@quiz.Name</div>

                        <div class="d-flex flex-row align-items-center mb-2">
                            <i class="far fa-clock icon-sm me-2"></i>
                            <span class="text-truncate">
                                <span class="fw-bold">Otwarcie:</span> 
                                @quiz.OpenDate
                            </span>
                        </div>
                        <div class="d-flex flex-row align-items-center mb-2">
                            <i class="far fa-clock icon-sm me-2"></i>
                            <span class="text-truncate">
                                <span class="fw-bold">Zamknięcie:</span> 
                                @quiz.CloseDate
                            </span>
                        </div>
                        <div class="d-flex flex-row align-items-center">
                            <i class="fas fa-user-group icon-sm me-2"></i>
                            <span class="text-truncate">
                                <span class="fw-bold">Wypełniono:</span> 
                                @Model.QuizesToUsersCompleted[quiz].Item1 / @Model.QuizesToUsersCompleted[quiz].Item2
                            </span>
                        </div>
                    </div>

                    <div class="d-flex flex-column h-100 ms-2">
                        <div class="d-flex flex-row">
                            <a asp-page="Creator" asp-route-id="@quiz.Id" class="btn-icon ms-auto">
                                <i class="fas fa-magnifying-glass icon-sm"></i>
                            </a>
                        </div>

                        <a href="#" class="btn btn-primary ms-auto mt-auto" data-bs-toggle="modal" data-bs-target="#assignPopup"
                           data-quiz-id="@quiz.Id" data-quiz-name="@quiz.Name" data-pin="@quiz.Code"
                           data-url="jakiś url" @*TODO: URL DO QUIZU*@
                           data-emails='["email1@example.com", "email2@example.com"]' @*TODO: UŻYTKOWNICY JUŻ DODANI DO QUIZU*@
                           data-all-groups='["Klasa 2A", "Klasa 3A", "Klasa 1B"]' @*TODO: WSZYSTKIE GRUPY NALEŻĄCE DO WŁAŚCICIELA QUIZU*@
                           data-added-groups='["Klasa 3A"]' @*TODO: GRUPY JUŻ DODANE DO QUIZU*@
                           data-callback-name="assign">
                            Udostępnij
                        </a>
                    </div>
                </div>
            }

            @if (closed.Count > 0)
            {
                <div class="fw-bold fs-4 mb-3">Zamknięte</div>
            }
            @foreach (var quiz in closed)
            {
                <div class="border rounded shadow-sm mb-3 p-0 d-flex flex-row flex-shrink-0 p-3">
                    <div class="flex-grow-1 d-flex flex-column flex-column flex-basis-0 overflow-hidden">
                        <div class="fw-bold fs-5 mb-3 text-truncate">@quiz.Name</div>

                        <div class="d-flex flex-row align-items-center mb-2">
                            <i class="far fa-clock icon-sm me-2"></i>
                            <span class="text-truncate">
                                <span class="fw-bold">Otwarcie:</span> 
                                @quiz.OpenDate
                            </span>
                        </div>
                        <div class="d-flex flex-row align-items-center mb-2">
                            <i class="far fa-clock icon-sm me-2"></i>
                            <span class="text-truncate">
                                <span class="fw-bold">Zamknięcie:</span> 
                                @quiz.CloseDate
                            </span>
                        </div>
                        <div class="d-flex flex-row align-items-center">
                            <i class="fas fa-user-group icon-sm me-2"></i>
                            <span class="text-truncate">
                                <span class="fw-bold">Wypełniono:</span> 
                                @Model.QuizesToUsersCompleted[quiz].Item1 / @Model.QuizesToUsersCompleted[quiz].Item2
                            </span>
                        </div>
                    </div>

                    <div class="d-flex flex-column h-100 ms-2">
                        <a asp-page="Grade" asp-route-id="@quiz.Id" class="btn btn-primary ms-auto mt-auto">Edytuj oceny</a>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="fw-bold fs-4 mb-3">Opublikowane</div>
            <p>Nie masz jeszcze żadnych opublikowanych quizów... Utwórz szkic oraz go opublikuj, a pojawi się on tutaj!</p>
        }
    </div>

    <div class="w-100 w-md-50 flex-grow-1 overflow-md-auto d-flex flex-column bg-white rounded shadow px-3 pt-3 mb-3"> 
        <div class="fw-bold fs-4 mb-3">Szkice</div>
        @foreach (var quiz in sketches)
        {
            <div class="border rounded shadow-sm mb-3 p-0 d-flex flex-row flex-shrink-0 p-3">
                <div class="flex-grow-1 d-flex flex-column flex-column flex-basis-0 overflow-hidden">
                    <div class="fw-bold fs-5 mb-3 text-truncate">@quiz.Name</div>

                    @* <div class="d-flex flex-row align-items-center mb-2">
                        <i class="far fa-clock icon-sm me-2"></i>
                        <span class="text-truncate">
                        <span class="fw-bold">Otwarcie: </span>@
                            quiz.OpenDate
                        </span>
                    </div>
                    <div class="d-flex flex-row align-items-center mb-2">
                        <i class="far fa-clock icon-sm me-2"></i>
                        <span class="text-truncate">
                        <span class="fw-bold">Zamknięcie:</span> 
                            @quiz.CloseDate
                        </span>
                    </div> *@
                    <div class="d-flex flex-row align-items-center mb-2">
                        <i class="fas fa-music icon-sm me-2"></i>
                        <span class="text-truncate">
                            <span class="fw-bold">Zadania:</span> 
                            @quiz.Excersises.Count
                        </span>
                    </div>
                    <div class="d-flex flex-row align-items-center mb-2">
                        <i class="fas fa-music icon-sm me-2"></i>
                        <span class="text-truncate">
                            <span class="fw-bold">Zadania:</span> 
                            @quiz.Excersises.Count
                        </span>
                    </div>
                    <div class="d-flex flex-row align-items-center">
                        <i class="fas fa-music icon-sm me-2"></i>
                        <span class="text-truncate">
                            <span class="fw-bold">Zadania:</span> 
                            @quiz.Excersises.Count
                        </span>
                    </div>
                </div>

                <div class="d-flex flex-column h-100 ms-2">
                    <div class="d-flex flex-row">
                        <a asp-page="Creator" asp-route-id="@quiz.Id" class="btn-icon me-3 ms-auto">
                            <i class="fas fa-pencil icon-sm"></i>
                        </a>

                        <form method="post" id="deleteFormForQuiz@(quiz.Id)">
                            <input type="hidden" asp-for="PostAction" value="delete" />
                            <input type="hidden" asp-for="QuizId" value="@quiz.Id" />

                            <a href="#" class="btn-icon" data-bs-toggle="modal" data-bs-target="#deleteQuizPopup"
                               data-quiz-name="@quiz.Name" data-on-delete="deleteQuiz(@quiz.Id)">
                                <i class="far fa-trash-can icon-sm"></i>
                            </a>
                        </form>
                    </div>

                    <a href="#" class="btn btn-primary mt-auto" data-bs-toggle="modal" data-bs-target="#publishPopup"
                       data-quiz-id="@quiz.Id" data-quiz-name="@quiz.Name" data-callback-name="publish">
                        Opublikuj
                    </a>
                </div>
            </div>
        }

        <a asp-page="Creator" class="no-style">
            <div class="quiz quiz-add rounded d-flex justify-content-center align-items-center">
                <i class="fas fa-plus me-1"></i>
                
                <span class="fw-bold">Utwórz nowy quiz</span>
            </div>
        </a>

        @*TODO: Remove this*@
        @* <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#assignPopup"
           data-quiz-id="3" data-quiz-name="Dummy quiz" data-pin="069 420"
           data-url="https://harmony.io/join?q=069420"
           data-emails='["email1@example.com", "email2@example.com"]'
           data-all-groups='["Klasa 2A", "Klasa 3A", "Klasa 1B"]'
           data-added-groups='["Klasa 3A"]' data-callback-name="assign">
            Test Assign
        </a> *@

        @*TODO: Remove this*@
        @* <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#publishPopup"
           data-quiz-id="3" data-quiz-name="Dummy quiz" data-callback-name="publish">
            Test Publish
        </a> *@
    </div>
</div>

<partial name="~/Pages/Shared/DeleteQuizPopup.cshtml" />
<partial name="~/Pages/Shared/PublishPopup.cshtml" />
<partial name="~/Pages/Shared/AssignPopup.cshtml" />

<script>
    function deleteQuiz(quizId) {
        document.getElementById(`deleteFormForQuiz${quizId}`).submit();
    }

    function publish(quizId, openDateTime, closeDateTime) {
        //TODO: Publish this quiz (open i close date są validowane w popupie, ale dobrze zrobić to jeszcze raz na backendzie)
      
        console.log("publishing quiz: " + quizId);
        console.log("open datetime: " + openDateTime);
        console.log("close datetime: " + closeDateTime);

        //TODO: Po opublikowaniu powinien od razu włączyć się assign popup
        // (można go włączyć przyciskiem Udostępnij, ale dobrze jakby włączał się też automatycznie)
    }

    function assign(quizId, assignedEmails, assignedGroups) {
        //TODO: Assign this quiz to users

        console.log("assigned quiz: " + quizId);
        console.log("assigned users: " + assignedEmails);
        console.log("assigned groups: " + assignedGroups);
    }

</script>
