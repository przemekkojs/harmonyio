@page
@model Main.Pages.GradeModel
@using Main.Enumerations;
@using JsonConvert = Newtonsoft.Json.JsonConvert;

<head>
    <link rel="stylesheet" href="~/css/grade-style.css" />
</head>

<form method="post" class="h-100 w-100 d-flex flex-column overflow-auto">
    <div class="flex-grow-1 d-flex overflow-auto">
        <div class="left-panel overflow-auto bg-white shadow rounded p-3 me-3">
            <div class="fw-bold fs-4 mb-3">@Model.Quiz.Name</div>
            <input type="hidden" asp-for="QuizId" value="@Model.Quiz.Id" />

            @for (int i = 0; i < Model.Users.Count; i++)
            {
                <div onclick="selectUser(@i)"
                    class="student-row d-flex flex-row @(i == Model.Users.Count - 1 ? "mb-3" : "mb-2")">
                    <div
                        class="student-div student-name flex-grow-1 rounded d-flex align-items-center p-2 me-2 overflow-hidden">
                        @Model.Users[i].FullName
                    </div>
                    <div id="user-grade-@i"
                        class="student-div student-grade rounded d-flex align-items-center justify-content-center p-2">
                        - @*SET VIA JS*@
                    </div>
                </div>
            }
        </div>

        <div class="flex-grow-1 d-flex flex-column overflow-auto ">
            <div class="bg-white rounded shadow d-flex justify-content-between align-items-center p-3 mb-3">
                <div id="current-user-text" class="fw-bold fs-4">
                    @*SET VIA JS*@
                </div>

                <div class="d-flex align-items-center">
                    <span class="fw-bold me-2">Wynik</span>
                    <div id="points-text"
                        class="border border-secondary text-secondary rounded fw-bold px-2 py-1 me-2 text-nowrap">
                        @*SET VIA JS*@
                    </div>
                    <div id="percentage-text"
                        class="border border-secondary text-secondary rounded fw-bold px-2 py-1 me-4">
                        @*SET VIA JS*@
                    </div>
                    <span class="fw-bold me-2">Ocena</span>
                    <select id="grade-select"
                        onchange="onGradeChange(this.value, this.options[this.selectedIndex].text)"
                        class="grade-select bg-transparent fw-bold form-select border border-secondary text-secondary rounded px-2 py-1"
                        aria-label="Wybierz ocenę">
                        <option selected disabled>-</option>
                        @foreach (Grade grade in Enum.GetValues(typeof(Grade)))
                        {
                            <option value="@grade">@grade.AsString()</option>
                        }
                    </select>

                    @for (int i = 0; i < Model.Users.Count; i++)
                    {
                        <input id="grade-hidden-@i" type="hidden" asp-for="Grades[i]" />
                    }
                </div>
            </div>

            <div class="flex-grow-1 bg-white rounded shadow d-flex flex-column p-3 overflow-auto">
                <div class="d-flex flex-row align-items-start question-area">
                    <div
                        class="question-square bg-secondary shadow rounded d-flex justify-content-center align-items-center me-2">
                        <div class="fs-1 text-white fw-bold" id="excersiseNumber">
                            @* FILLED VIA JS*@
                        </div>
                    </div>

                    <div class="flex-grow-1 me-2 h-100">
                        <textarea id="comment" rows="1" placeholder="Dodaj komentarz..." oninput="resizeTextArea(this)"
                            onchange="onCommentChange(this.value)"
                            class="form-control shadow border-white rounded overflow-hidden h-100"></textarea>
                    </div>

                    <div class="question-square flex-grow-1 rounded bg-secondary shadow d-flex flex-column justify-content-center align-items-center p-1 me-2">
                        <span class="fw-bold text-white mb-1">Sugestia</span>
                        <input type="text" id="suggestion" readonly
                            class="form-control points-input bg-transparent text-white px-0 text-dark rounded overflow-visible" />
                    </div>

                    <div class="question-square flex-grow-1 rounded bg-secondary shadow d-flex flex-column justify-content-center align-items-center p-1 me-2">
                        <span class="fw-bold text-white mb-1">Wynik</span>
                        <input type="number" id="points" onchange="onPointsChange(this.value)"
                            onKeyPress="integerKeyPress(event)"
                            class="form-control points-input bg-white text-dark rounded" />
                    </div>

                    <div
                        class="question-square flex-grow-1 rounded bg-secondary shadow d-flex flex-column justify-content-center align-items-center p-1 me-2">
                        <span class="fw-bold text-white mb-1">Max</span>
                        <input type="number" id="max" onchange="onMaxChange(this.value)"
                            onKeyPress="integerKeyPress(event)"
                            class="form-control points-input bg-white text-dark rounded" />
                    </div>
                </div>

                <div class="flex-grow-1 mt-3" id="question-area">
                    <p class="m-0" id="question">
                        @* FILLED VIA JS *@
                    </p>
                </div>

                <div class="mt-3 d-flex flex-row">
                    @for (int i = 0; i < Model.Excersises.Count; i++)
                    {
                        @for (int j = 0; j < Model.Users.Count; j++)
                        {
                            <input id="points-hidden-@i-@j" type="hidden" asp-for="Points[j][i]" value="0" />
                            <input id="max-hidden-@i-@j" type="hidden" asp-for="Maxes[j][i]" value="0" />
                            <input id="comment-hidden-@i-@j" type="hidden" asp-for="Comments[j][i]" value="" />
                        }
                    }

                    <div id="music-staff-div"
                        class="flex-grow-1 h-100 rounded bg-white shadow d-flex justify-content-center align-items-center">
                        @* MUSIC STAFF DIV SET VIA JS *@
                    </div>
                </div>

                @* <div class="mt-3">
                    <span class="fw-bold">Komentarz</span>
                    <textarea id="comment" rows="1" placeholder="Dodaj komentarz..." oninput="resizeTextArea(this)"
                        onchange="onCommentChange(this.value)"
                        class="form-control shadow border-white rounded overflow-hidden mt-2"></textarea>
                </div> *@
            </div>
        </div>
    </div>

    <div class="py-3 d-flex align-items-center">
        <a asp-page="Created" class="btn btn-danger btn-std-width me-auto">Powrót</a>
        @* <span asp-validation-for="Grades" id="grades-validation-text" class="text-danger me-3"></span> *@

        <div id="excersises-buttons" class="d-flex align-items-center">
            @*EXCERSISES ARE FILLED WITH JS SCRIPT*@
        </div>
        <div id="div-last-ex">
            <img src="~/images/three_dots.png" alt="Three dots" class="ms-2 three-dots-img">
            <button id="btn-last-ex" type="button" onclick="lastQuestion()"
                class="btn btn-outline-secondary btn-tiny-width p-1 ms-2"></button>
        </div>

        <button type="submit" class="btn btn-secondary btn-std-width ms-3">Zapisz oceny</button>
    </div>

</form>

<script>
    // needed to allow overflow from canvas div, but now navbar is hiding
    // TODO try fix this
    @* const mainContainer = document.getElementById('layout-main-container');
        if (mainContainer) {
        mainContainer.classList.remove('overflow-auto');
        mainContainer.style.overflow = 'visible';
        } *@

    const fontUrl = '@Url.Content("~/fonts/Inconsolata.otf")'

    const symbolPaths = {
        curlyBrace: '@Url.Content("~/images/staff-symbols/curly-brace.png")',
        bassKey: '@Url.Content("~/images/staff-symbols/bass-key.png")',
        violinKey: '@Url.Content("~/images/staff-symbols/violin-key.png")',
        bemol: '@Url.Content("~/images/staff-symbols/bemol.png")',
        doubleBemol: '@Url.Content("~/images/staff-symbols/double-bemol.png")',
        sharp: '@Url.Content("~/images/staff-symbols/sharp.png")',
        doubleSharp: '@Url.Content("~/images/staff-symbols/double-sharp.png")',
        natural: '@Url.Content("~/images/staff-symbols/natural.png")',
        fullNote: '@Url.Content("~/images/staff-symbols/full-note.png")',
        noteHeadClosed: '@Url.Content("~/images/staff-symbols/note-head-closed.png")',
        noteHeadOpened: '@Url.Content("~/images/staff-symbols/note-head-opened.png")',
        noteFlag: '@Url.Content("~/images/staff-symbols/note-flag.png")',
        mouse: '@Url.Content("~/images/staff-symbols/mouse.png")',
        noteReverse: '@Url.Content("~/images/staff-symbols/note-reverse.png")',
        thrashCan: '@Url.Content("~/images/staff-symbols/thrash-can.png")',
        thrashCanCrossed: '@Url.Content("~/images/staff-symbols/thrash-can-crossed.png")',
    };

    let canvasWidth = 978;
    let canvasHeight = 800;

    const questionsRaw = @Html.Raw(JsonConvert.SerializeObject(Model.Excersises.Select(e => e.Question)));
    const questions = questionsRaw.map(q => JSON.parse(q));
    const userSolutions = @Html.Raw(JsonConvert.SerializeObject(Model.Users.Select(u => Model.UsersToSolutions[u].Select(es => es.Answer))));

    let currentUserIndex = 0;
    let currentQuestionIndex = 0;

    function getCurrentSolution() {
        return userSolutions[currentUserIndex][currentQuestionIndex]
    }
</script>

<script src="~/lib/p5/p5.min.js"></script>
<script src="~/js/staff-scripts/constants.js"></script>
<script src="~/js/staff-scripts/symbols.js"></script>
<script src="~/js/staff-scripts/bar.js"></script>
<script src="~/js/staff-scripts/vertical.js"></script>
<script src="~/js/staff-scripts/twoNotes.js"></script>
<script src="~/js/staff-scripts/functionSymbol.js"></script>
<script src="~/js/staff-scripts/note.js"></script>
<script src="~/js/staff-scripts/keySignature.js"></script>
<script src="~/js/staff-scripts/metre.js"></script>
<script src="~/js/staff-scripts/accidental.js"></script>
<script src="~/js/staff-scripts/staff.js"></script>
<script src="~/js/staff-scripts/sketchGrading.js"></script>

<script>
    const usernames = @Html.Raw(JsonConvert.SerializeObject(Model.Users.Select(u => u.FullName)));
    const userScoreSuggestions = @Html.Raw(JsonConvert.SerializeObject(Model.Users.Select(u => Model.UsersToGradings[u])));

    const userScores = @(Model.Points == null ?
        Html.Raw(JsonConvert.SerializeObject(Model.Users.Select(u => Model.UsersToGradings[u]))) :
        Html.Raw(JsonConvert.SerializeObject(Model.Users.Select((u, index) => Model.Points[index].Zip(Model.Maxes[index], (x, y) => (x, y)).ToList())))
        );

    const userComments = @Html.Raw(JsonConvert.SerializeObject(Model.Comments))
        ?? Array.from({ length: usernames.length }, () => Array(@Model.Excersises.Count).fill(""));

    const userGrades = @Html.Raw(JsonConvert.SerializeObject(Model.Grades?.Select(g => new[] { g?.ToString() ?? "-", g?.AsString() ?? "-" }) ?? null))
        ?? Array.from({ length: usernames.length }, () => ["-", "-"]);

    const studentRows = Array.from(document.querySelectorAll('div.student-row'));
    const currentUserText = document.getElementById("current-user-text");
    const pointsText = document.getElementById("points-text");
    const percentageText = document.getElementById("percentage-text");
    const gradeSelect = document.getElementById("grade-select");
    const questionElement = document.getElementById("question");
    const excersiseNumberElement = document.getElementById("excersiseNumber");
    const suggestionElement = document.getElementById("suggestion");
    const pointsElement = document.getElementById("points");
    const maxElement = document.getElementById("max");
    const commentElement = document.getElementById("comment");

    for (let i = 0; i < @Model.Excersises.Count; i++) {
        for (let j = 0; j < @Model.Users.Count; j++) {
            document.getElementById(`points-hidden-${i}-${j}`).value = userScores[j][i].Item1;
            document.getElementById(`max-hidden-${i}-${j}`).value = userScores[j][i].Item2;
            document.getElementById(`comment-hidden-${i}-${j}`).value = userComments[j][i];
        }
    }
    for (let i = 0; i < @Model.Users.Count; i++) {
        if (userGrades[i][0] != "-") {
            document.getElementById(`user-grade-${i}`).innerText = userGrades[i][1];
            document.getElementById(`grade-hidden-${i}`).value = userGrades[i][0];
        }
    }

    function loadUser(index, loadToGrandStaff = true) {
        handleStudentsList(index);
        handleTotalPoints(index);

        currentUserText.innerText = usernames[index];
        gradeSelect.value = userGrades[index][0];

        loadQuestion(0, loadToGrandStaff);
    }

    function handleTotalPoints(index) {
        var [totalPoints, totalMax] = getUserTotalPointsAndMax(index);
        pointsText.innerText = totalPoints + " / " + totalMax;
        percentageText.innerText = Math.round((totalPoints / totalMax) * 100) + "%";
    }

    function handleStudentsList(index) {
        const currentStudentRow = studentRows.filter(div => div.textContent.includes(usernames[index]))[0];
        const otherStudentsRow = studentRows.filter(div => div != currentStudentRow);

        currentStudentRow.classList.add("focused-student");
        currentStudentRow.classList.remove('unfocused-student');

        otherStudentsRow.forEach(div => {
            div.classList.add('unfocused-student');
            div.classList.remove('focused-student');
        });
    }

    function selectUser(index) {
        currentUserIndex = index;
        loadUser(currentUserIndex);
    }

    function getUserTotalPointsAndMax(userIndex) {
        var totalPoints = 0;
        var totalMax = 0;

        var scores = userScores[userIndex];
        scores.forEach((score) => {
            totalPoints += score.Item1;
            totalMax += score.Item2;
        });

        return [totalPoints, totalMax];
    }

    function onGradeChange(value, strValue) {
        userGrades[currentUserIndex] = [value, strValue];
        document.getElementById(`user-grade-${currentUserIndex}`).innerText = strValue;
        document.getElementById(`grade-hidden-${currentUserIndex}`).value = value;
    @* document.getElementById("grades-validation-text").innerText = ''; *@
    }

    function onPointsChange(value) {
        var numValue = Number(value);
        var maxValue = Number(userScores[currentUserIndex][currentQuestionIndex].Item2);

        if (value === "") {
            numValue = userScoreSuggestions[currentUserIndex][currentQuestionIndex].Item1;
            document.getElementById(`points-${currentQuestionIndex}`).value = numValue;
        }
        if (numValue > maxValue) {
            numValue = maxValue;
            document.getElementById(`points-${currentQuestionIndex}`).value = numValue;
        }

        userScores[currentUserIndex][currentQuestionIndex].Item1 = numValue;
        document.getElementById(`points-hidden-${currentQuestionIndex}-${currentUserIndex}`).value = numValue;

        handleTotalPoints(currentUserIndex);
    }

    function onMaxChange(value) {
        var numValue = Number(value);

        if (value === "") {
            numValue = userScoreSuggestions[currentUserIndex][currentQuestionIndex].Item2;
            document.getElementById(`points-${currentQuestionIndex}`).value = numValue;
        }

        userScores[currentUserIndex][currentQuestionIndex].Item2 = numValue;
        document.getElementById(`max-hidden-${currentQuestionIndex}-${currentUserIndex}`).value = numValue;

        handleTotalPoints(currentUserIndex);
    }

    function onCommentChange(value) {
        userComments[currentUserIndex][currentQuestionIndex] = value;
        document.getElementById(`comment-hidden-${currentQuestionIndex}-${currentUserIndex}`).value = value;
    }

    function resizeTextArea(textArea) {
        @* textArea.style.height = ''; *@
        @* textArea.style.height = textArea.scrollHeight + 'px'; *@
    }

    function integerKeyPress(e) {
        if (!/\d/.test(e.key)) {
            e.preventDefault();
        }
    }


    function loadQuestion(index, loadToGrandStaff = true) {
        if (index >= 0 && index < questions.length) {
            currentQuestionIndex = index;

            questionElement.innerText = questions[currentQuestionIndex].question;
            if (questions[currentQuestionIndex].question == '')
                document.getElementById('question-area').classList.add('d-none');
            else 
                document.getElementById('question-area').classList.remove('d-none');

            excersiseNumberElement.innerHTML = currentQuestionIndex + 1;

            var score = userScores[currentUserIndex][currentQuestionIndex];
            var scoreSuggestions = userScoreSuggestions[currentUserIndex][currentQuestionIndex];

            suggestionElement.value = scoreSuggestions.Item1 + " / " + scoreSuggestions.Item2;
            pointsElement.placeholder = scoreSuggestions.Item1;
            maxElement.placeholder = scoreSuggestions.Item2;
            pointsElement.value = score.Item1;
            maxElement.value = score.Item2;
            //solutionElement.innerText = userSolutions[currentUserIndex][currentQuestionIndex];
            if (loadToGrandStaff) {
                grandStaff.loadFromJson(questions[currentQuestionIndex], userSolutions[currentUserIndex][currentQuestionIndex])
            }

            commentElement.value = userComments[currentUserIndex][currentQuestionIndex];
            resizeTextArea(commentElement);

            generateButtons(currentQuestionIndex);
        }
    }

    const maxVisibleButtons = 9;
    const targetVisibleOneSide = Math.floor(maxVisibleButtons / 2)
    function generateButtons(index) {
        var questionButtonsContainer = document.getElementById("excersises-buttons");
        questionButtonsContainer.innerHTML = '';

        var start = Math.max(index - targetVisibleOneSide, 0);
        var end = Math.min(index + targetVisibleOneSide, questions.length - 1);

        var missingStart = start - (index - targetVisibleOneSide);
        var missingEnd = (index + targetVisibleOneSide) - end;

        if (missingStart > 0 && missingEnd == 0) {
            end = Math.min(end + missingStart, questions.length - 1);
        }
        else if (missingEnd > 0 && missingStart == 0) {
            start = Math.max(start - missingEnd, 0);
        }

        if (end == questions.length - 2) {
            end++;
        }

        for (var i = start; i <= end; i++) {
            var button = document.createElement("button");
            button.className = "btn " + (i === index ? "btn-secondary btn-current" : "btn-light btn-hidable") + " btn-tiny-width p-1";
            button.innerText = i + 1;

            button.onclick = (function (i) {
                return function () {
                    currentIndex = i;
                    loadQuestion(currentIndex);
                };
            })(i);

            questionButtonsContainer.appendChild(button);

            if (i !== start) {
                button.classList.add("ms-2");
            }
        }

        document.getElementById("btn-last-ex").innerText = questions.length;
        document.getElementById("div-last-ex").style.display = end < questions.length - 1 ? 'inline-block' : 'none';
    }

    loadUser(currentUserIndex, false);

</script>
