@page
@model Main.Pages.ListJoined
@using Main.Enumerations
@{
    var finished = Model.Joined.Where(q => q.Excersises.First().ExcersiseSolutions.Any(es => es.UserId == Model.AppUser.Id)).ToList();
    var unfinished = Model.Joined.Except(finished).ToList();

    var toSolve = unfinished.Where(q => q.State == Enumerations.QuizState.Open).ToList();
    var futureQuizes = unfinished.Except(toSolve).ToList();
}

<head>
    <link rel="stylesheet" href="~/css/quiz-lists-style.css" />
</head>

<div class="h-100 w-100 d-flex flex-row overflow-auto">
    <div class="w-50 flex-grow-1 overflow-auto d-flex flex-column pe-3">
        @if (unfinished.Count > 0)
        {
            @if (toSolve.Count > 0)
            {
                <div class="fw-bold fs-4 mb-3">Do Rozwiązania</div>
            }
            @foreach (var quiz in toSolve)
            {
                <div class="quiz p-0 flex-shrink-0 d-flex flex-row overflow-hidden p-3">
                    <div class="flex-grow-1 d-flex flex-column">
                        <div class="fw-bold fs-5 mb-3">@quiz.Name</div>

                        <div class="d-flex flex-row align-items-center mb-2">
                            <i class="far fa-clock icon-sm me-2"></i>
                            <span class="fw-bold me-1">Pozostało:</span>
                            <span>do uzupełnienia</span>
                        </div>
                        <div class="d-flex flex-row align-items-center mb-2">
                            <i class="fas fa-music icon-sm me-2"></i>
                            <span class="fw-bold me-1">Zadania:</span>
                            <span>@quiz.Excersises.Count</span>
                        </div>
                        <div class="d-flex flex-row align-items-center">
                            <i class="fas fa-user icon-sm me-2"></i>
                            <span class="fw-bold me-1">Twórca:</span>
                            <span>@quiz.Creator.FullName</span>
                        </div>
                    </div>

                    <div class="d-flex flex-column h-100">
                        <a href="/solve?id=@quiz.Id" class="btn btn-outline-primary ms-auto mt-auto">Rozwiąż</a>
                    </div>
                </div>
            }

            @if (futureQuizes.Count > 0)
            {
                <div class="fw-bold fs-4 mb-3">Zaplanowane</div>
            }
            @foreach (var quiz in futureQuizes)
            {
                <div class="quiz p-0 flex-shrink-0 d-flex flex-row overflow-hidden p-3">
                    <div class="flex-grow-1 d-flex flex-column">
                        <div class="fw-bold fs-5 mb-3">@quiz.Name</div>

                        <div class="d-flex flex-row align-items-center mb-2">
                            <i class="far fa-clock icon-sm me-2"></i>
                            <span class="fw-bold me-1">Dostępne za:</span>
                            <span>do uzupełnienia</span>
                        </div>
                        <div class="d-flex flex-row align-items-center mb-2">
                            <i class="fas fa-music icon-sm me-2"></i>
                            <span class="fw-bold me-1">Zadania:</span>
                            <span>@quiz.Excersises.Count</span>
                        </div>
                        <div class="d-flex flex-row align-items-center">
                            <i class="fas fa-user icon-sm me-2"></i>
                            <span class="fw-bold me-1">Twórca:</span>
                            <span>@quiz.Creator.FullName</span>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="fw-bold fs-4 mb-3">Zaplanowane</div>
            <p>Nie masz aktualnie żadnych zaplanowanych, ani trwających quizów. Po dołączeniu będziesz mógł go rozwiązać tutaj!</p>
        }
        </div>

    <div class="vr"></div>

    <div class="w-50 flex-grow-1 overflow-auto d-flex flex-column ps-3">
        @if (finished.Count > 0)
        {
            <div class="fw-bold fs-4 mb-3">Zakończone</div>
            @foreach (var quiz in finished)
            {
                var quizResult = quiz.QuizResults.FirstOrDefault(qr => qr.UserId == Model.AppUser.Id);

                <div class="quiz p-0 flex-shrink-0 d-flex flex-row overflow-hidden p-3">
                    <div class="flex-grow-1 d-flex flex-column">
                        <div class="fw-bold fs-5">@quiz.Name</div>

                        @if (quizResult != null)
                        {
                            <div class="d-flex flex-row align-items-center mt-3 mb-2">
                                <i class="far fa-clock icon-sm me-2"></i>
                                <span class="fw-bold me-1">Oceniono:</span>
                                <span>do uzupełnienia</span>
                            </div>
                        }
                        else
                        {
                            <span style="margin-top: -4px;">Oczekuje na ocenę...</span>
                            <div style="height: 28px;"></div>
                        }

                        <div class="d-flex flex-row align-items-center mb-2">
                            <i class="fas fa-music icon-sm me-2"></i>
                            <span class="fw-bold me-1">Zadania:</span>
                            <span>@quiz.Excersises.Count</span>
                        </div>
                        <div class="d-flex flex-row align-items-center">
                            <i class="fas fa-user icon-sm me-2"></i>
                            <span class="fw-bold me-1">Twórca:</span>
                            <span>@quiz.Creator.FullName</span>
                        </div>
                    </div>

                    <div class="d-flex flex-column h-100">
                        @if (quizResult != null)
                        {
                            <div class="d-flex flex-row">
                                <div class="fw-bold fs-5 ms-auto">
                                    @(((Grade)(quizResult.Grade!)).AsString())
                                </div>
                            </div>
                        }

                        <a href="/browse?id=@quiz.Id" class="btn btn-outline-primary ms-auto mt-auto">Przeglądaj</a>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="fw-bold fs-4 mb-3">Zakończone</div>
            <p>Nie masz jeszcze żadnych zakończonych quizów... Dołącz do quizu i rozwiąż go, a wyniki pojawią się tutaj!</p>
        }
    </div>
</div>















@*<div class="container mt-5">
        <div class="row mb-3">
            <h2>Otwarte</h2>
        </div>
        <div class="row mb-3">
            <div class="p-2">
                <div class="row align-items-center">
                    <div class="col-3">
                        <strong>Nazwa</strong>
                    </div>
                    <div class="col-3">
                        <strong>Termin</strong>
                    </div>
                    <div class="col-6 text-end">

                    </div>
                </div>
            </div>
        </div>
        @foreach (var quiz in Model.Joined)
        {
            <div class="row mb-3">
                <div class="card p-3 bg-light">
                    <div class="row align-items-center">
                        <div class="col-3">
                            @quiz.Name
                        </div>
                        <div class="col-3">
                            @quiz.CloseDate
                        </div>
                        <div class="col-6 text-end">
                            <a href="/solve?@quiz.Id" class="btn btn-outline-primary btn-sm">Zobacz</a>
                        </div>
                    </div>
                </div>
            </div>
        }

    </div>
    <hr class="mt-3"/>
    <div class="container mt-3">

        <div class="row mb-3">
            <h2>Zamknięte</h2>
        </div>
        <div class="row mb-3">
            <div class="p-2">
                <div class="row align-items-center">
                    <div class="col-3">
                        <strong>Nazwa</strong>
                    </div>
                    <div class="col-3">
                        <strong>Data zakończenia</strong>
                    </div>
                    <div class="col-3">
                        <strong>Ocena</strong>
                    </div>
                    <div class="col-3 text-end">

                    </div>
                </div>
            </div>
        </div>
        @foreach (var quiz in Model.Joined.Where(q => q.CloseDate < DateTime.Now))
        {
            <div class="row mb-3">
                <div class="card p-3 bg-light">
                    <div class="row align-items-center">
                        <div class="col-3">
                            @quiz.Name
                        </div>
                        <div class="col-3">
                            @quiz.CloseDate
                        </div>
                        <div class="col-3">
                            @quiz.QuizResults.Where(qr => qr.User == Model.AppUser).Select(qr => qr.Grade.HasValue ? qr.Grade.ToString() : "nie ocenione").First()
                        </div>
                        <div class="col-3 text-end">
                            <a href="/solve?@quiz.Id" class="btn btn-outline-primary btn-sm">Zobacz</a>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>*@